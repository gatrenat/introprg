###########################################################
|exerciseicon__T| Exercici 36_04. Recuperar l'identificador
###########################################################

.. rubric:: Context

* Carpeta de lliurament: ``36_04_id/``

* Continguts relacionats: :doc:`bd_consultes`

* Com lliurar-lo: :ref:`instruccions <instruccions_git>`

* [✓] Exercici amb :ref:`autoavaluació<descripcio_exercicis_autoavaluacio>`

.. rubric:: Enunciat

Si recordes el mètode ``afegeixCategoria()`` que es proposa als apunts,
teníem:

.. code-block:: java
    :linenos:

    public void afegeixCategoria(Categoria categoria) throws SQLException {
        String sql = String.format(
                "INSERT INTO CATEGORIES (nom) VALUES ('%s')",
                categoria.getNom());
        Statement st = null;
        try {
            st = conn.createStatement();
            st.executeUpdate(sql);
        } finally {
            if (st != null) {
                st.close();
            }
        }
    }

Aquest mètode està prou bé però presenta un problema: a partir del moment
que introduïm una categoria a la base de dades, el seu identificador ja
pot ser conegut.

Malauradament, tal i com tenim codificat ``afegeixCategoria()``, la
instància de ``Categoria`` que hem afegit continua tenint el mateix ``id``
desconegut. Com ho podríem resoldre?

A l'exercici :doc:`anterior <exercici_36_03_select>` hem creat el mètode
``obteCategoriaPerNom()`` que ens permet recuperar una categoria un cop
introduïda a la base de dades. Podem simplement modificar el ``id`` de la
categoria per aquest i ja està.

La definició de la classe ``Categoria`` no disposa de *setter* així que li
haurem d'afegir. Assegura't que controles el cas que el valor rebut no
sigui adequat de manera que sigui coherent amb el constructor.

El següent ``UsaZoo`` et permetrà comprovar si has fet el que s'esperava.

.. code-block:: java
    :linenos:

    import java.sql.SQLException;
    public class UsaZoo {
        public static void main( String args[]) throws SQLException {
            Zoo zoo = new Zoo();

            System.out.print("Primer connectem amb la base de dades: ");
            zoo.connecta();
            System.out.println("connectat");

            System.out.println("Creem la taula CATEGORIES");
            zoo.creaTaulaCategories();

            System.out.println();
            System.out.println("Mostrem les categories disponibles inicialment");
            ZooUtils.mostraCategories(zoo.recuperaCategories());

            Categoria ocell = new Categoria("ocell");
            Categoria mamifer = new Categoria("mamífer");
            System.out.println();
            System.out.println("Inserim les categories: ");
            System.out.println("\t"+ ocell);
            System.out.println("\t"+ mamifer);
            zoo.afegeixCategoria(ocell);
            zoo.afegeixCategoria(mamifer);

            System.out.println();
            System.out.println("Un cop inserides les categories queden: ");
            System.out.println("\t"+ ocell);
            System.out.println("\t"+ mamifer);

            System.out.println();
            System.out.println("Mostrem les categories disponibles finalment");
            ZooUtils.mostraCategories(zoo.recuperaCategories());

            System.out.println();
            System.out.print("Finalment tanquem la connexió amb la base de dades: ");
            zoo.desconnecta();
            System.out.println("desconnectat");
        }
    }

La sortida esperada és:

.. code-block:: console
    :emphasize-lines: 2-

    $ java UsaZoo
    Primer connectem amb la base de dades: connectat
    Creem la taula CATEGORIES

    Mostrem les categories disponibles inicialment
    Cap categoria

    Inserim les categories:
        Categoria(id:indefinit, ocell)
        Categoria(id:indefinit, mamífer)

    Un cop inserides les categories queden:
        Categoria(id:1, ocell)
        Categoria(id:2, mamífer)

    Mostrem les categories disponibles finalment
    Nombre de categories: 2
        Categoria(id:2, mamífer)
        Categoria(id:1, ocell)
    Finalment tanquem la connexió amb la base de dades: desconnectat

Fixa't que la secció que mostra les categories un cop inserides, ara
sí mostra els identificadors.

Ampliació
=========

Potser t'ha semblat una mica pobre la manera en que hem hagut de recuperar
l'identificador? Et proposo una manera alternativa i, probablement més
adequada: fent servir el mètode ``getGeneratedKeys()`` de ``Statement``.

El fragment de codi que caldrà afegir a ``afegeixCategoria()`` és, un cop
executada la comanda d'inserció:

.. code-block:: java
    :linenos:

    ResultSet rs = st.getGeneratedKeys();
    rs.next();
    int id = rs.getInt(1);

En breu, aquest codi obté un ``ResultSet`` amb els identificadors que ha
generat el SGBD en la seva darrera inserció i extrau el primer d'ells. Com
que la nostra comanda d'inserció només insereix una categoria cada cop,
només haurà d'haver-hi un d'identificador.

Si et ve de gust, pots fer servir aquesta opció en comptes de la versió
*cutre* de cridar ``obteCategoriaPerNom()``. Les proves de l'exercici no es queixaran.

